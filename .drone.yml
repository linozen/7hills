---
kind: pipeline
type: docker
name: 7hills

workspace:
  path: /home/deployr/7hills

steps:
- name: deploy backend
  image: docker/compose:1.29.1
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  commands:
  - docker-compose -f docker-compose.back.yml build --pull
  - docker-compose -f docker-compose.back.yml up -d

- name: deploy frontend
  image: docker/compose:1.29.1
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  commands:
  - docker-compose -f docker-compose.front.yml build --pull
  - docker-compose -f docker-compose.front.yml up -d

- name: deploy analytics
  image: docker/compose:1.29.1
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  environment:
    HASH_SALT:
      from_secret: salt
    POSTGRES_DB:
      from_secret: db_name
    POSTGRES_USER:
      from_secret: db_user
    POSTGRES_PASSWORD:
      from_secret: db_pass
  commands:
  - docker-compose -f docker-compose.analytics.yml pull --include-deps
  - docker-compose -f docker-compose.front.yml up -d

trigger:
  branch:
  - master
  event:
  - push

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock

...
